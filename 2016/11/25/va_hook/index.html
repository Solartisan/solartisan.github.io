<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> VirtualApp Hook 框架分析 · Solartisan</title><meta name="description" content="VirtualApp Hook 框架分析 - solart"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://solart.cc/atom.xml" title="Solartisan"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/logo.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">HOME</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/solartisan" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">VirtualApp Hook 框架分析</h1><div class="post-info">Nov 25, 2016</div><div class="post-content"><p>作者：<a href="mailto://imilko7@gmail.com" target="_blank" rel="external">solart</a></p>
<blockquote>
<p>版权声明：本文图文为博主原创，转载请注明出处。</p>
</blockquote>
<h2 id="1、概述"><a href="#1、概述" class="headerlink" title="1、概述"></a>1、概述</h2><p>对于插件化框架 <code>Hook</code> 机制是一个核心，那到底 <code>Hook</code> 是什么呢？怎么去理解插件化中的 <code>Hook</code> 呢？在我看来插件化中的 <code>Hook</code> 机制就是通过<code>反射注入</code>和<code>动态代理</code>来实现的。</p>
<p>先来说说何为<code>反射注入</code>，大家都知道依赖注入，其实反射注入算是依赖注入的一种，顾名思义，通过反射的方式将依赖对象注入目标对象。举个例子，想要替换掉 <code>ActivityThread</code> 中的 <code>mInstrumentation</code>：</p>
<a id="more"></a>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*android.app.ActivityThread.java*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityThread</span> </span>&#123;</span><br><span class="line">    Instrumentation mInstrumentation;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ActivityThread <span class="title">currentActivityThread</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> sCurrentActivityThread;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Instrumentation代理类</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InstrumentationDelegate</span> <span class="keyword">extends</span> <span class="title">Instrumentation</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Instrumentation base;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InstrumentationDelegate</span><span class="params">(Instrumentation base)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.base = base;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReflectInject</span></span>&#123;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reflectInject</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 根据全类名获取Class</span></span><br><span class="line">        Class&lt;?&gt; activityThreadClass = Class.forName(<span class="string">"android.app.ActivityThread"</span>);</span><br><span class="line">        <span class="comment">// 获取无参的currentActivityThread函数</span></span><br><span class="line">        Method currentActivityThreadMethod = activityThreadClass.getMethod(<span class="string">"currentActivityThread"</span>);</span><br><span class="line">        <span class="comment">// 调用currentActivityThread函数获取当前ActivityThread对象</span></span><br><span class="line">        currentActivityThreadMethod.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        Object currentActivityThreadObject = currentActivityThreadMethod.invoke(<span class="keyword">null</span>);</span><br><span class="line">        <span class="comment">// 获取mInstrumentation字段</span></span><br><span class="line">        Field instrumentationField = activityThreadClass.getDeclaredField(<span class="string">"mInstrumentation"</span>);</span><br><span class="line">        <span class="comment">// 破坏封装获取对象</span></span><br><span class="line">        instrumentationField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        Object instrumentationObject = instrumentationField.get(currentActivityThreadObject);</span><br><span class="line">        <span class="comment">// 注入Instrumentation代理对象</span></span><br><span class="line">        <span class="keyword">if</span>(!(instrumentationObject <span class="keyword">instanceof</span> InstrumentationDelegate)) &#123;</span><br><span class="line">            instrumentationField.set(activityThreadClass, <span class="keyword">new</span> InstrumentationDelegate((Instrumentation)instrumentationObject));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上就是对于 <code>mInstrumentation</code> 的反射注入，当然凭借封装可以有更优雅的实现，这里为了方便展示过程粗暴直接。</p>
<p>关于<code>动态代理</code>大家可以参考<a href="http://www.cnblogs.com/flyoung2008/archive/2013/08/11/3251148.html" target="_blank" rel="external">彻底理解 Java 动态代理</a>这篇文章，写得十分清晰。文章最后也提到了动态代理的局限性，动态代理无法支持对于非接口的类进行代理，所以在 <code>Hook</code> 时一般结合静态代理来特殊处理需要代理的类，比较典型的例子是 <code>android.app.Instrumentation</code> 的代理。好在 Android 系统服务大都通过 <code>Binder</code> 机制来实现的，而 <code>Binder</code> 机制的 C/S 架构对于接口的支持天然的好，这对于整个 <code>Hook</code> 框架中代理类实现的工作量来说就大大的减少了。</p>
<h2 id="2、Hook-框架"><a href="#2、Hook-框架" class="headerlink" title="2、Hook 框架"></a>2、Hook 框架</h2><p>我们知道 Hook 本身依赖反射机制，从上面示例上也可以看出，直接使用大量反射导致代码可读性、维护性变得非常差，从代码美观可读性、易维护性上来看，一个可读性强易维护的 Hook 框架显得尤为重要，目前众多开源的插件化框架中 <a href="https://github.com/asLody/VirtualApp" target="_blank" rel="external">VirtualApp</a> 的 Hook 框架是最优秀的。为什么这么说呢，作者使用了基于注解的反射注入技术，合理的框架设计使得虽然 Hook 的对象非常多，代码却井井有条，不得不赞叹作者 lody 的巧妙构思，让人受益良多。</p>
<p>以下分析基于 master 分支 c493161 版本。</p>
<h4 id="2-1-设计类图"><a href="#2-1-设计类图" class="headerlink" title="2.1 设计类图"></a>2.1 设计类图</h4><p> 又到了祭出法宝的时候了，废话不多说先看设计类图：</p>
<p><img src="/images/va_hook_diagram.png" alt="VA Diagram"></p>
<p><a href="/images/va_hook_diagram.png">点击放大查看高清无码大图</a></p>
<h4 id="2-2-类图解析"><a href="#2-2-类图解析" class="headerlink" title="2.2 类图解析"></a>2.2 类图解析</h4><p>首先作者设计了两个接口，一个是 <code>Injectable</code> ，这个接口比较简单，使实现这个接口的类都具备的注入的能力；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Injectable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">inject</span><span class="params">()</span> <span class="keyword">throws</span> Throwable</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">isEnvBad</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>另一个是 <code>IHookObject</code> ，使实现这个接口的类具备管理代理类的 <code>Hook 函数</code>能力。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IHookObject</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">copyHooks</span><span class="params">(IHookObject from)</span></span>;</span><br><span class="line"></span><br><span class="line">	Map&lt;String, Hook&gt; getAllHooks();</span><br><span class="line"></span><br><span class="line">	<span class="function">Hook <span class="title">addHook</span><span class="params">(Hook hook)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function">Hook <span class="title">removeHook</span><span class="params">(String hookName)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">removeHook</span><span class="params">(Hook hook)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">removeAllHook</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	&lt;H extends Hook&gt; <span class="function">H <span class="title">getHook</span><span class="params">(String name)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function">Object <span class="title">getProxyInterface</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function">Object <span class="title">getBaseInterface</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">getHookCount</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面我们提到了 <code>Hook 函数</code>这个概念，怎么理解这个概念呢，因为动态代理的调用是函数级别的，所以 Hook 相当于替换函数实现。再来看 <code>Hook</code> 这个抽象类，这个类定义了 Hook 的处理时机，以及提供一些 Hook 环境的依赖，实现类通过指定代理函数名，可以根据需要在 <code>beforeCall</code> 、<code>call</code> 、 <code>afterCall</code> 执行逻辑处理。所以， <code>Hook</code> 的实现类可以理解为代理函数的类象化。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Hook</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> enable = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> String <span class="title">getName</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">beforeCall</span><span class="params">(Object who, Method method, Object... args)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">call</span><span class="params">(Object who, Method method, Object... args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> method.invoke(who, args);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">afterCall</span><span class="params">(Object who, Method method, Object[] args, Object result)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isEnable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> enable;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEnable</span><span class="params">(<span class="keyword">boolean</span> enable)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.enable = enable;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">	<span class="annotation">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">"Hook$&#123; "</span> + getName() + <span class="string">" &#125;"</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>来看看抽象类 <code>HookDelegate</code>  ，它是 <code>IHookObject</code> 的接口实现，在构造中通过 <code>HookHandler</code> 完成了动态代理，内部维护了 <code>Hook</code> 集合，代码如下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">HookDelegate</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">IHookObject</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = HookDelegate.class.getSimpleName();</span><br><span class="line">	<span class="keyword">private</span> T mBaseInterface;</span><br><span class="line">	<span class="keyword">private</span> T mProxyInterface;</span><br><span class="line">	<span class="comment">/**</span><br><span class="line">	 * 内部维护的Hook集合</span><br><span class="line">	 */</span></span><br><span class="line">	<span class="keyword">private</span> Map&lt;String, Hook&gt; internalHookMapping = <span class="keyword">new</span> HashMap&lt;String, Hook&gt;();</span><br><span class="line"></span><br><span class="line">	<span class="annotation">@Override</span></span><br><span class="line">	<span class="keyword">public</span> Map&lt;String, Hook&gt; getAllHooks() &#123;</span><br><span class="line">		<span class="keyword">return</span> internalHookMapping;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">HookDelegate</span><span class="params">(Class&lt;?&gt;... proxyInterfaces)</span> </span>&#123;</span><br><span class="line">         <span class="comment">// 获取接口，完成动态代理</span></span><br><span class="line">		mBaseInterface = createInterface();</span><br><span class="line">		<span class="keyword">if</span> (mBaseInterface != <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span> (proxyInterfaces == <span class="keyword">null</span>) &#123;</span><br><span class="line">				proxyInterfaces = HookUtils.getAllInterface(mBaseInterface.getClass());</span><br><span class="line">			&#125;</span><br><span class="line">			mProxyInterface = (T) Proxy.newProxyInstance(mBaseInterface.getClass().getClassLoader(), proxyInterfaces, <span class="keyword">new</span> HookHandler());</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			VLog.d(TAG, <span class="string">"Unable to build HookDelegate: %s."</span>, getClass().getName());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">HookDelegate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>((Class[]) <span class="keyword">null</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> T <span class="title">createInterface</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="annotation">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">copyHooks</span><span class="params">(IHookObject from)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.internalHookMapping.putAll(from.getAllHooks());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 添加 Hook 函数</span></span><br><span class="line">	<span class="annotation">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Hook <span class="title">addHook</span><span class="params">(Hook hook)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (hook != <span class="keyword">null</span> &amp;&amp; !TextUtils.isEmpty(hook.getName())) &#123;</span><br><span class="line">			<span class="keyword">if</span> (internalHookMapping.containsKey(hook.getName())) &#123;</span><br><span class="line">				VLog.w(TAG, <span class="string">"Hook(%s) from class(%s) have been added, can't add again."</span>, hook.getName(),</span><br><span class="line">						hook.getClass().getName());</span><br><span class="line">				<span class="keyword">return</span> hook;</span><br><span class="line">			&#125;</span><br><span class="line">			internalHookMapping.put(hook.getName(), hook);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> hook;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span><br><span class="line">	 * <span class="doctag">@return</span> 包装后的代理对象</span><br><span class="line">	 */</span></span><br><span class="line">	<span class="annotation">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> T <span class="title">getProxyInterface</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> mProxyInterface;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span><br><span class="line">	 * <span class="doctag">@return</span> 原对象</span><br><span class="line">	 */</span></span><br><span class="line">	<span class="annotation">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> T <span class="title">getBaseInterface</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> mBaseInterface;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">HookHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line">         <span class="comment">// 动态代理，通过函数名找到对应的 Hook 函数，完成 beforeCall、call、afterCall 的调用</span></span><br><span class="line">		<span class="annotation">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">			Hook hook = getHook(method.getName());</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				<span class="keyword">if</span> (hook != <span class="keyword">null</span> &amp;&amp; hook.isEnable()) &#123;</span><br><span class="line">					<span class="keyword">if</span> (hook.beforeCall(mBaseInterface, method, args)) &#123;</span><br><span class="line">						Object res = hook.call(mBaseInterface, method, args);</span><br><span class="line">						res = hook.afterCall(mBaseInterface, method, args, res);</span><br><span class="line">						<span class="keyword">return</span> res;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">return</span> method.invoke(mBaseInterface, args);</span><br><span class="line">			&#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">				Throwable cause = e.getTargetException();</span><br><span class="line">				<span class="keyword">if</span> (cause != <span class="keyword">null</span>) &#123;</span><br><span class="line">					<span class="keyword">throw</span> cause;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">throw</span> e;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于 <code>HookBinderDelegate</code> 这个类，继承自 <code>HookDelegate</code> 扩展了 <code>IBinder</code> 接口，借此方便处理系统 <code>Binder</code> 服务的代理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">HookBinderDelegate</span> <span class="keyword">extends</span> <span class="title">HookDelegate</span>&lt;<span class="title">IInterface</span>&gt; <span class="keyword">implements</span> <span class="title">IBinder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> IBinder mBaseBinder;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">HookBinderDelegate</span><span class="params">(Class&lt;?&gt;... proxyInterfaces)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(proxyInterfaces);</span><br><span class="line">		init();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">HookBinderDelegate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>();</span><br><span class="line">		init();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		mBaseBinder = getBaseInterface() != <span class="keyword">null</span> ? getBaseInterface().asBinder() : <span class="keyword">null</span>;</span><br><span class="line">		addHook(<span class="keyword">new</span> AsBinder());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//此处通过反射替换系统服务</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">replaceService</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (mBaseBinder != <span class="keyword">null</span>) &#123;</span><br><span class="line">			ServiceManager.sCache.get().put(name, <span class="keyword">this</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//这里Hook asBinder函数，使该函数调用后返回代理Binder对象。</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">AsBinder</span> <span class="keyword">extends</span> <span class="title">Hook</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="annotation">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">"asBinder"</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="annotation">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> Object <span class="title">call</span><span class="params">(Object who, Method method, Object... args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">			<span class="keyword">return</span> HookBinderDelegate.<span class="keyword">this</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Context <span class="title">getContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> VirtualCore.get().getContext();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">	<span class="annotation">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> IInterface <span class="title">queryLocalInterface</span><span class="params">(String descriptor)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> getProxyInterface();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> IBinder <span class="title">getBaseBinder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> mBaseBinder;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接在在来看 <code>PatchDelegate</code> 这个抽象类，它是 <code>Injectable</code> 的接口实现，依赖 <code>@Patch</code>及 <code>@ApiLimit</code> 注解将 <code>Hook</code> 类的添加进 <code>Hook</code> 集合；它的泛型为 <code>IHookObject</code> ，这就意味着 <code>HookDelegate</code>  <code>HookBinderDelegate</code> 的实现类很容易通过泛型约束，并通过 <code>inject</code> 接口完成注入。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">PatchDelegate</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">IHookObject</span>&gt; <span class="keyword">implements</span> <span class="title">Injectable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">protected</span> T hookDelegate;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">protected</span> Object baseObject;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">PatchDelegate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>(<span class="keyword">null</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">PatchDelegate</span><span class="params">(Object baseObject)</span> </span>&#123;</span><br><span class="line">		attachInterface(baseObject);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">attachInterface</span><span class="params">(Object baseObject)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.baseObject = baseObject;</span><br><span class="line">		<span class="keyword">this</span>.hookDelegate = createHookDelegate();</span><br><span class="line">		onBindHooks();</span><br><span class="line">		afterHookApply(hookDelegate);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> T <span class="title">createHookDelegate</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onBindHooks</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (hookDelegate == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">         <span class="comment">// 通过 @Patch、@ApiLimit 注解将 Hook 函数添加至代理类的 Hook 集合</span></span><br><span class="line">		Class&lt;? extends PatchDelegate&gt; clazz = getClass();</span><br><span class="line">		Patch patch = clazz.getAnnotation(Patch.class);</span><br><span class="line">		<span class="keyword">int</span> version = Build.VERSION.SDK_INT;</span><br><span class="line">		<span class="keyword">if</span> (patch != <span class="keyword">null</span>) &#123;</span><br><span class="line">			Class&lt;?&gt;[] hookTypes = patch.value();</span><br><span class="line">			<span class="keyword">for</span> (Class&lt;?&gt; hookType : hookTypes) &#123;</span><br><span class="line">				ApiLimit apiLimit = hookType.getAnnotation(ApiLimit.class);</span><br><span class="line">				<span class="keyword">boolean</span> needToAddHook = <span class="keyword">true</span>;</span><br><span class="line">				<span class="keyword">if</span> (apiLimit != <span class="keyword">null</span>) &#123;</span><br><span class="line">					<span class="keyword">int</span> apiStart = apiLimit.start();</span><br><span class="line">					<span class="keyword">int</span> apiEnd = apiLimit.end();</span><br><span class="line">					<span class="keyword">boolean</span> highThanStart = apiStart == -<span class="number">1</span> || version &gt; apiStart;</span><br><span class="line">					<span class="keyword">boolean</span> lowThanEnd = apiEnd == -<span class="number">1</span> || version &lt; apiEnd;</span><br><span class="line">					<span class="keyword">if</span> (!highThanStart || !lowThanEnd) &#123;</span><br><span class="line">						needToAddHook = <span class="keyword">false</span>;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> (needToAddHook) &#123;</span><br><span class="line">					addHook(hookType);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addHook</span><span class="params">(Class&lt;?&gt; hookType)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Constructor&lt;?&gt; constructor = hookType.getDeclaredConstructors()[<span class="number">0</span>];</span><br><span class="line">			<span class="keyword">if</span> (!constructor.isAccessible()) &#123;</span><br><span class="line">				constructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			Hook hook;</span><br><span class="line">			<span class="keyword">if</span> (constructor.getParameterTypes().length == <span class="number">0</span>) &#123;</span><br><span class="line">				hook = (Hook) constructor.newInstance();</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				hook = (Hook) constructor.newInstance(<span class="keyword">this</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			hookDelegate.addHook(hook);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Unable to instance Hook : "</span> + hookType + <span class="string">" : "</span> + e.getMessage());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Hook <span class="title">addHook</span><span class="params">(Hook hook)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> hookDelegate.addHook(hook);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">afterHookApply</span><span class="params">(T delegate)</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="annotation">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">inject</span><span class="params">()</span> <span class="keyword">throws</span> Throwable</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Context <span class="title">getContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> VirtualCore.get().getContext();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> T <span class="title">getHookDelegate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> hookDelegate;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后再来说说 <code>PatchManager</code> ，这个类顾名思义就知道是补丁的管理类，在这里将各个 <code>Patch</code> 完成注入。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">PatchManager</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = PatchManager.class.getSimpleName();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Map&lt;Class&lt;?&gt;, Injectable&gt; injectTable = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">12</span>);</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="title">PatchManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> PatchManager <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> PatchManagerHolder.sPatchManager;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">injectAll</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (Injectable injectable : injectTable.values()) &#123;</span><br><span class="line">			injectable.inject();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// <span class="doctag">XXX:</span> Lazy inject the Instrumentation,</span></span><br><span class="line">		<span class="comment">// It is important in many cases.</span></span><br><span class="line">		addPatch(AppInstrumentation.getDefault());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isInit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> PatchManagerHolder.sInit;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (PatchManagerHolder.sInit) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"PatchManager Has been initialized."</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		injectInternal();</span><br><span class="line">		PatchManagerHolder.sInit = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">injectInternal</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (VirtualCore.get().isMainProcess()) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (VirtualCore.get().isServerProcess()) &#123;</span><br><span class="line">			addPatch(<span class="keyword">new</span> ActivityManagerPatch());</span><br><span class="line">			addPatch(<span class="keyword">new</span> PackageManagerPatch());</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (VirtualCore.get().isVAppProcess()) &#123;</span><br><span class="line">			addPatch(<span class="keyword">new</span> LibCorePatch());</span><br><span class="line">			addPatch(<span class="keyword">new</span> ActivityManagerPatch());</span><br><span class="line">			addPatch(<span class="keyword">new</span> PackageManagerPatch());</span><br><span class="line">             addPatch(HCallbackHook.getDefault());</span><br><span class="line">             <span class="comment">//以下省略诸多Path</span></span><br><span class="line">			...</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addPatch</span><span class="params">(Injectable injectable)</span> </span>&#123;</span><br><span class="line">		injectTable.put(injectable.getClass(), injectable);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> &lt;T extends Injectable&gt; <span class="function">T <span class="title">findPatch</span><span class="params">(Class&lt;T&gt; clazz)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// noinspection unchecked</span></span><br><span class="line">		<span class="keyword">return</span> (T) injectTable.get(clazz);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> &lt;T extends Injectable&gt; <span class="function"><span class="keyword">void</span> <span class="title">checkEnv</span><span class="params">(Class&lt;T&gt; clazz)</span> </span>&#123;</span><br><span class="line">		Injectable injectable = findPatch(clazz);</span><br><span class="line">		<span class="keyword">if</span> (injectable != <span class="keyword">null</span> &amp;&amp; injectable.isEnvBad()) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				injectable.inject();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> &lt;T extends Injectable, H extends IHookObject&gt; <span class="function">H <span class="title">getHookObject</span><span class="params">(Class&lt;T&gt; patchClass)</span> </span>&#123;</span><br><span class="line">		T patch = findPatch(patchClass);</span><br><span class="line">		<span class="keyword">if</span> (patch != <span class="keyword">null</span> &amp;&amp; patch <span class="keyword">instanceof</span> PatchDelegate) &#123;</span><br><span class="line">			<span class="comment">// noinspection unchecked</span></span><br><span class="line">			<span class="keyword">return</span> (H) ((PatchDelegate) patch).getHookDelegate();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">PatchManagerHolder</span> </span>&#123;</span><br><span class="line">		<span class="keyword">private</span> <span class="keyword">static</span> PatchManager sPatchManager = <span class="keyword">new</span> PatchManager();</span><br><span class="line">		<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> sInit;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-3-过程梳理"><a href="#2-3-过程梳理" class="headerlink" title="2.3 过程梳理"></a>2.3 过程梳理</h4><p>如果感觉以上内容不好理解的话，下面的这幅图，可能会缓解这种不适感。</p>
<p><img src="/images/va_hook_seq.png" alt="va hook"></p>
<p>以 <code>AccountManagerService</code> Hook 为例，①、② 两步将 <code>AccountBinderDelegate</code> 等 Binder 代理注入至 <code>ServiceManager</code> ，假设触发 ③ getService 获取  <code>AccountManagerService</code> 后，调用 ④ getPwd ，这时 ⑤ getPwd 将通过 <code>HookHandler</code> 动态代理调用到代理类 ⑥ getHook 查找到函数代理对象，然后 ⑦ invoke 完成 <code>Hook 函数</code> 即 getPassword 代理调用。</p>
<p>到这里，整个 Hook 框架大致上就说完了。当然诸多版本的 Rom（官方、第三方）适配还是一个庞大的工作量，这就体现了作者对整个 Android Framework 掌握的功力了，这里额外提一下，作者对于Framework 镜像的处理，也是相当的精妙，这也为整个 Hook 框架的代码可读性贡献了相当一部分的力量，详见项目的 <a href="https://github.com/asLody/VirtualApp/tree/master/VirtualApp/lib/src/main/java/mirror" target="_blank" rel="external"><code>mirror</code></a> 包 。</p>
<h2 id="3、最后的闲扯"><a href="#3、最后的闲扯" class="headerlink" title="3、最后的闲扯"></a>3、最后的闲扯</h2><p>在阅读源码以及优秀开源项目的时候，大多数人都会感到很难读的通，我的一个看法和切身体会是，就像你第一眼看到一个人，肯定感觉十分陌生，而相处过一段时间后，这种陌生感就会慢慢消失，进而你反而会很了解她，知道她的爱好，知道她喜欢吃什么。阅读源码也是这样，短时间内如果无法拿下，又很想理解它，那么就要多花些时间，去读，不断的读和理解，了解源码所涉及的知识，尝试去用自己的理解去揣摩作者的思路，这个期间你需要用适合自己学习的方式（比如画类图，流程图、时序图，只要这种方式对你是有效的不必拘泥于形式）去记录修正你的理解，不断的去逼近作者的想法和思路，这也是一个学习成长的过程。</p>
<p>道阻且长，行则将至。that’s all.</p>
</div></article></div></section><footer><div class="paginator"><a href="/2016/12/06/keep_alive_push/" class="prev">上一篇</a><a href="/2016/11/16/plugin_classloader/" class="next">下一篇</a></div><div style="padding:0; margin: 30px auto; width: 100%; text-align: center;"><div style="font-size: 1em; margin: 10px auto;color:#f44336;font-weight: bold"> 如果觉得本文对你有帮助，不妨请作者喝瓶养乐多<div style="padding: 0; margin: 10px auto; width: 100%; text-align: center; color:#f44336;"></div></div><button style="cursor: pointer; border: 0; outline: 0; padding: 0; margin: 0; letter-spacing: normal; text-transform: none; text-indent: 0; text-shadow: none; background-color: transparent; text-align: center; cursor: pointer;" id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}"><span style="display: inline-block; width: 70px; height: 70px; color: #fff; font-weight: bold; font-style: normal; font-variant: normal; font-stretch: normal; font-size: 2.5em; text-align: center; line-height: 70px; background: #f44336; -moz-border-radius: 50%; -webkit-border-radius: 50%; border-radius: 50%;">赏</span></button><div id="QR" style="display: none;"><div id="wechat" style="width: auto; max-width: 50%; float: left; margin: 20px; display: inline-block;"><img id="wechat_qr" src="/images/wechat.png" alt="WechatPay"></div><div id="alipay" style="width: auto; max-width: 50%; float: right; margin: 20px; display: inline-block;"><img id="alipay_qr" src="/images/alipay.png" alt="Alipay"></div></div></div><div id="cloud-tie-wrapper" class="cloud-tie-wrapper"><script src="https://img1.cache.netease.com/f2e/tie/yun/sdk/loader.js"></script><script>var cloudTieConfig = {
url: document.location.href,
sourceId: "",
productKey: "8b0c22fa1d324f8e9c45b4f8e5d5c325",
target: "cloud-tie-wrapper"
};
var yunManualLoad = true;
Tie.loader("aHR0cHM6Ly9hcGkuZ2VudGllLjE2My5jb20vcGMvbGl2ZXNjcmlwdC5odG1s", true);
</script></div><div class="copyright"><p>© 2015 - 2017 <a href="http://solart.cc">solart</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-51018462-1",'auto');ga('send','pageview');</script></body></html>