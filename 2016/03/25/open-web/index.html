<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Android WebView加载html5及JS交互框架 · Solartisan</title><meta name="description" content="Android WebView加载html5及JS交互框架 - solart"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://solart.cc/atom.xml" title="Solartisan"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/logo.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">HOME</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/solartisan" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">Android WebView加载html5及JS交互框架</h1><div class="post-info">Mar 25, 2016</div><div class="post-content"><p>当前越来越多的app中嵌入H5，想跟大家分享一下具体在项目中的使用和设计，故写了这个<a href="https://github.com/Solartisan/OpenWeb" target="_blank" rel="external">开源项目</a>，欢迎大家批评指正。</p>
<p>在这里介绍一下OpenWeb项目基础的框架设计。</p>
<h1 id="1-功能介绍"><a href="#1-功能介绍" class="headerlink" title="1.功能介绍"></a>1.功能介绍</h1><p>基于WebView设计的H5页面的加载框架，可以自动管理回退栈，可以支持js与native的交互，可配合下拉刷新控件，可修改横向进度条。</p>
<h1 id="2-设计"><a href="#2-设计" class="headerlink" title="2.设计"></a>2.设计</h1><img src="/images/open_web.png">
<a id="more"></a>
<h1 id="3-核心类功能介绍"><a href="#3-核心类功能介绍" class="headerlink" title="3.核心类功能介绍"></a>3.核心类功能介绍</h1><h2 id="3-1-WebUrl-java"><a href="#3-1-WebUrl-java" class="headerlink" title="3.1 WebUrl.java"></a>3.1 WebUrl.java</h2><p>定义了<code>String getCurrentUrl()</code>接口，获取当前页面的的URL，用于记录当前页面的js回调注册。</p>
<h2 id="3-2-BaseWebEvent-java"><a href="#3-2-BaseWebEvent-java" class="headerlink" title="3.2 BaseWebEvent.java"></a>3.2 BaseWebEvent.java</h2><p>该类主要封装了基础的<code>@JavascriptInterface</code>接口，Handler消息常量定义及js的回调注册。</p>
<p>构造函数如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">BaseWebEvent</span><span class="params">(Context context, Handler handler, WebUrl url)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.mContext = context;</span><br><span class="line">    <span class="keyword">this</span>.mHandler = handler;</span><br><span class="line">    <span class="keyword">this</span>.mListener = <span class="keyword">new</span> HashMap();</span><br><span class="line">    <span class="keyword">this</span>.mUrlSource = url;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Handler消息封装如下，用于<code>@JavascriptInterface</code>接口发送消息处理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@param</span> what</span><br><span class="line"> * <span class="doctag">@param</span> obj</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendAsyncCallbackMessage</span><span class="params">(<span class="keyword">int</span> what, Object obj)</span> </span>&#123;</span><br><span class="line">    sendAsyncCallbackMessageDelay(what,obj,<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span><br><span class="line">  *</span><br><span class="line">  * <span class="doctag">@param</span> what</span><br><span class="line">  * <span class="doctag">@param</span> obj</span><br><span class="line">  * <span class="doctag">@param</span> delay</span><br><span class="line">  */</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendAsyncCallbackMessageDelay</span><span class="params">(<span class="keyword">int</span> what, Object obj,<span class="keyword">long</span> delay)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">if</span> (mHandler != <span class="keyword">null</span>) &#123;</span><br><span class="line">         Message msg = mHandler.obtainMessage();</span><br><span class="line">         msg.what = what;</span><br><span class="line">         msg.obj = obj;</span><br><span class="line">         mHandler.sendMessageDelayed(msg,delay);</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-3-BaseWebFragment-java"><a href="#3-3-BaseWebFragment-java" class="headerlink" title="3.3 BaseWebFragment.java"></a>3.3 BaseWebFragment.java</h2><p>这个类为抽象类是主要的WebView承载类，内部定义了WebView及BaseWebEvent及网络状态变化的监听等。</p>
<p>WebView的<code>Settings</code>配置，主要针对WebView做基础的设置，<code>WebChromeClient</code>,<code>WebViewClient</code>设置，以及对下载监听的设置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onInitWebViewSettings</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//这里设置了基础的Settings</span></span><br><span class="line">    WebSettingsUtil.initSettings(<span class="keyword">this</span>.mActivity, <span class="keyword">this</span>.mWebView);</span><br><span class="line">    WebChromeClient webChromeClient = onCreateWebChromeClient();</span><br><span class="line">    <span class="keyword">if</span> (webChromeClient != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mWebView.setWebChromeClient(webChromeClient);</span><br><span class="line">    &#125;</span><br><span class="line">    WebViewClient webViewClient = onCreateWebViewClient();</span><br><span class="line">    <span class="keyword">if</span> (webViewClient != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mWebView.setWebViewClient(webViewClient);</span><br><span class="line">    &#125;</span><br><span class="line">    mWebView.setOverScrollMode(View.OVER_SCROLL_NEVER);</span><br><span class="line">    mWebView.requestFocus();</span><br><span class="line">    mWebView.setDownloadListener(<span class="keyword">new</span> WebDownloadListener(<span class="keyword">this</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在子类的实现中应该覆写以下两个方法用于<code>WebChromeClient</code>,<code>WebViewClient</code>的设置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> WebChromeClient <span class="title">onCreateWebChromeClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> BaseWebChromeClient(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> WebViewClient <span class="title">onCreateWebViewClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> BaseWebViewClient(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意，要关注WebView可能存在内存泄露的问题，所以在Fragment的生命周期中针对WebView做相应操作，避免内存泄露问题</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onResume();</span><br><span class="line">    <span class="keyword">if</span> (mWebView != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.mWebView.onResume();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPause</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onPause();</span><br><span class="line">    <span class="keyword">if</span> (mWebView != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mWebView.onPause();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onDestroy();</span><br><span class="line">    <span class="keyword">if</span> (mWebView != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ((ViewGroup) mWebView.getParent()).removeView(mWebView);</span><br><span class="line">        mWebView.destroy();</span><br><span class="line">        mWebView = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>作为实现类必须实现以下两个函数，分别用于提供一个layout和一个下拉刷新的监听</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">loadLayoutRes</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">getWebViewId</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>
<h2 id="3-5-OpenWebFragment-java"><a href="#3-5-OpenWebFragment-java" class="headerlink" title="3.5 OpenWebFragment.java"></a>3.5 OpenWebFragment.java</h2><p>BaseWebFragment的子类，主要具体实现H5加载的业务逻辑。</p>
<p>其中，覆写<code>onInitWebViewSettings</code>方法，初始化<code>mBaseEvent</code>以及添加JavascriptInterface支持</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onInitWebViewSettings</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onInitWebViewSettings();</span><br><span class="line">    <span class="keyword">this</span>.mHandler = <span class="keyword">new</span> WebFragmentHandler(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">this</span>.mWebEvent = <span class="keyword">new</span> OpenWebEvent(<span class="keyword">this</span>, <span class="keyword">this</span>.mActivity, <span class="keyword">this</span>.mHandler, <span class="keyword">new</span> WebUrl() &#123;</span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getCurrentUrl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> mWebView.getUrl();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">this</span>.mWebView.addJavascriptInterface(<span class="keyword">this</span>.mWebEvent, <span class="string">"MyJsBridge"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div></article></div></section><footer><div class="paginator"><a href="/2016/05/14/code-specification/" class="prev">上一篇</a><a href="/2016/02/20/hello-world/" class="next">下一篇</a></div><div style="padding:0; margin: 30px auto; width: 100%; text-align: center;"><div style="font-size: 1em; margin: 10px auto;color:#f44336;font-weight: bold"> 如果觉得本文对你有帮助，不妨请作者喝瓶养乐多<div style="padding: 0; margin: 10px auto; width: 100%; text-align: center; color:#f44336;"></div></div><button style="cursor: pointer; border: 0; outline: 0; padding: 0; margin: 0; letter-spacing: normal; text-transform: none; text-indent: 0; text-shadow: none; background-color: transparent; text-align: center; cursor: pointer;" id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}"><span style="display: inline-block; width: 70px; height: 70px; color: #fff; font-weight: bold; font-style: normal; font-variant: normal; font-stretch: normal; font-size: 2.5em; text-align: center; line-height: 70px; background: #f44336; -moz-border-radius: 50%; -webkit-border-radius: 50%; border-radius: 50%;">赏</span></button><div id="QR" style="display: none;"><div id="wechat" style="width: auto; max-width: 50%; float: left; margin: 20px; display: inline-block;"><img id="wechat_qr" src="/images/wechat.png" alt="WechatPay"></div><div id="alipay" style="width: auto; max-width: 50%; float: right; margin: 20px; display: inline-block;"><img id="alipay_qr" src="/images/alipay.png" alt="Alipay"></div></div></div><div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div><script src="https://img1.cache.netease.com/f2e/tie/yun/sdk/loader.js"></script><script>var cloudTieConfig = {
    url: document.location.href,
    sourceId: "",
    productKey: "8b0c22fa1d324f8e9c45b4f8e5d5c325",
    target: "cloud-tie-wrapper"
};
var yunManualLoad = true;
Tie.loader("aHR0cHM6Ly9hcGkuZ2VudGllLjE2My5jb20vcGMvbGl2ZXNjcmlwdC5odG1s", true);
</script><div class="copyright"><p>© 2015 - 2020 <a href="http://solart.cc">solart</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-51018462-1",'auto');ga('send','pageview');</script></body></html>