<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 理解token在Framework中的产生及作用 · Solartisan</title><meta name="description" content="理解token在Framework中的产生及作用 - imilk"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://solart.cc/atom.xml" title="Solartisan"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/logo.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">HOME</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/solartisan" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">理解token在Framework中的产生及作用</h1><div class="post-info">Sep 15, 2016</div><div class="post-content"><p>作者：<a href="mailto://imilko7@gmail.com" target="_blank" rel="external">imilk</a></p>
<blockquote>
<p>版权声明：本文为博主原创，转载请注明出处。</p>
</blockquote>
<p>在梳理<a href="http://solart.cc/2016/08/20/launch_app/">应用启动流程分析</a>的过程中，在涉及到AMS以及ApplicationThread互相调用的流程中，有不少的方法涉及到了一个参数<code>IBinder token</code>的传递，当时并没有阐述这部分内容，现在我们来研究一下这个出现在很多地方的token到底是什么，在系统中起到了一个什么样的作用。</p>
<h2 id="1、追寻token"><a href="#1、追寻token" class="headerlink" title="1、追寻token"></a>1、追寻token</h2><p>我们知道Context提供了一个应用的运行环境，在Context的大环境里，应用才可以访问资源，才能完成和其他组件、服务的交互，这个入手点就锁定在了ContextImpl这个Context的真正的实现类上</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Common implementation of Context API, which provides the base</span><br><span class="line"> * context object for Activity and other application components.</span><br><span class="line"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ContextImpl</span> <span class="keyword">extends</span> <span class="title">Context</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="title">ContextImpl</span><span class="params">(ContextImpl container, ActivityThread mainThread,</span><br><span class="line">            LoadedApk packageInfo, IBinder activityToken, UserHandle user, <span class="keyword">boolean</span> restricted,</span><br><span class="line">            Display display, Configuration overrideConfiguration)</span> </span>&#123;</span><br><span class="line">         ...</span><br><span class="line">         mActivityToken = activityToken;</span><br><span class="line">	&#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>果不其然我们找到了token的影子<code>IBinder activityToken</code>，并在构造中赋值给成员变量<code>mActivityToken</code>，构造函数私有而对外提供了三个静态函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> ContextImpl <span class="title">createSystemContext</span><span class="params">(ActivityThread mainThread)</span> </span>&#123;</span><br><span class="line">       LoadedApk packageInfo = <span class="keyword">new</span> LoadedApk(mainThread);</span><br><span class="line">       ContextImpl context = <span class="keyword">new</span> ContextImpl(<span class="keyword">null</span>, mainThread,</span><br><span class="line">               packageInfo, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">       context.mResources.updateConfiguration(context.mResourcesManager.getConfiguration(),</span><br><span class="line">               context.mResourcesManager.getDisplayMetricsLocked(Display.DEFAULT_DISPLAY));</span><br><span class="line">       <span class="keyword">return</span> context;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">static</span> ContextImpl <span class="title">createAppContext</span><span class="params">(ActivityThread mainThread, LoadedApk packageInfo)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (packageInfo == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"packageInfo"</span>);</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> ContextImpl(<span class="keyword">null</span>, mainThread,</span><br><span class="line">               packageInfo, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">static</span> ContextImpl <span class="title">createActivityContext</span><span class="params">(ActivityThread mainThread,</span><br><span class="line">           LoadedApk packageInfo, IBinder activityToken)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (packageInfo == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"packageInfo"</span>);</span><br><span class="line">       <span class="keyword">if</span> (activityToken == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"activityInfo"</span>);</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> ContextImpl(<span class="keyword">null</span>, mainThread,</span><br><span class="line">               packageInfo, activityToken, <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>从参数名称以及以上三个静态函数中，我们也能推测出，<code>token</code>的产生恐怕只与Activity的有关。</p>
<p>当然猜测是靠不住的，既然我们想弄明白这个<code>token</code>到底是什么时候创建的，那我们就从源头找起，我们知道应用第一次启动会执行<code>ActivityThread</code>的<code>main</code>函数，而main函数中又调用<code>attach</code>函数创建并注册Application信息，去查看了调用链相关代码确实没有与<code>token</code>生成有关的代码（这个大家可以去看源码，这里为了简便就不在赘述大量代码）。</p>
<p>继续追踪代码至ActivityStackSupervisor::realStartActivityLocked函数，我们在这部分代码中找到了一些信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityStackSupervisor</span> <span class="keyword">implements</span> <span class="title">DisplayListener</span> </span>&#123;</span><br><span class="line">	...</span><br><span class="line">	<span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">realStartActivityLocked</span><span class="params">(ActivityRecord r,</span><br><span class="line">            ProcessRecord app, <span class="keyword">boolean</span> andResume, <span class="keyword">boolean</span> checkConfig)</span></span><br><span class="line">            <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">		...</span><br><span class="line">		r.app = app;</span><br><span class="line">		...</span><br><span class="line">          </span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			...</span><br><span class="line">			app.thread.scheduleLaunchActivity(<span class="keyword">new</span> Intent(r.intent), r.appToken,</span><br><span class="line">                    System.identityHashCode(r), r.info, <span class="keyword">new</span> Configuration(mService.mConfiguration),</span><br><span class="line">                    r.compat, r.launchedFromPackage, r.task.voiceInteractor, app.repProcState,</span><br><span class="line">                    r.icicle, r.persistentState, results, newIntents, !andResume,</span><br><span class="line">                    mService.isNextTransitionForward(), profilerInfo);</span><br><span class="line">			...</span><br><span class="line">		&#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">			...</span><br><span class="line">		&#125;</span><br><span class="line">		...</span><br><span class="line">	&#125;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>scheduleLaunchActivity</code>函数中参数中r.appToken正是我们要找的token。</p>
<h2 id="2、token的创建"><a href="#2、token的创建" class="headerlink" title="2、token的创建"></a>2、token的创建</h2><p>那我们来看是什么时候创建的ActivityRecord，<a href="http://solart.cc/images/launcher_app.png">应用启动流程分析流程图</a>中ActivityStackSupervisor::startActivityLocked这个函数中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityStackSupervisor</span> <span class="keyword">implements</span> <span class="title">DisplayListener</span> </span>&#123;</span><br><span class="line">	...</span><br><span class="line">	<span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityLocked</span><span class="params">(IApplicationThread caller,</span><br><span class="line">            Intent intent, String resolvedType, ActivityInfo aInfo,</span><br><span class="line">            IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span><br><span class="line">            IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</span><br><span class="line">            <span class="keyword">int</span> callingPid, <span class="keyword">int</span> callingUid, String callingPackage,</span><br><span class="line">            <span class="keyword">int</span> realCallingPid, <span class="keyword">int</span> realCallingUid, <span class="keyword">int</span> startFlags, Bundle options,</span><br><span class="line">            <span class="keyword">boolean</span> componentSpecified, ActivityRecord[] outActivity, ActivityContainer container,</span><br><span class="line">            TaskRecord inTask)</span> </span>&#123;</span><br><span class="line">         ...</span><br><span class="line">         ActivityRecord r = <span class="keyword">new</span> ActivityRecord(mService, callerApp, callingUid, callingPackage,</span><br><span class="line">                intent, resolvedType, aInfo, mService.mConfiguration, resultRecord, resultWho,</span><br><span class="line">                requestCode, componentSpecified, <span class="keyword">this</span>, container, options);</span><br><span class="line">         ...</span><br><span class="line">	&#125;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其实从以上流程可以看到其实在ActivityRecord创建时，与ActivityRecord绑定的Token就生成了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * An entry in the history stack, representing an activity.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityRecord</span> </span>&#123;</span><br><span class="line">	...</span><br><span class="line">	ActivityRecord(ActivityManagerService _service, ProcessRecord _caller,</span><br><span class="line">            <span class="keyword">int</span> _launchedFromUid, String _launchedFromPackage, Intent _intent, String _resolvedType,</span><br><span class="line">            ActivityInfo aInfo, Configuration _configuration,</span><br><span class="line">            ActivityRecord _resultTo, String _resultWho, <span class="keyword">int</span> _reqCode,</span><br><span class="line">            <span class="keyword">boolean</span> _componentSpecified, ActivityStackSupervisor supervisor,</span><br><span class="line">            ActivityContainer container, Bundle options) &#123;</span><br><span class="line">	    service = _service;</span><br><span class="line">	    appToken = <span class="keyword">new</span> Token(<span class="keyword">this</span>);</span><br><span class="line">	    ...</span><br><span class="line">	&#125;</span><br><span class="line">	...</span><br><span class="line">	<span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Token</span> <span class="keyword">extends</span> <span class="title">IApplicationToken</span>.<span class="title">Stub</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> WeakReference&lt;ActivityRecord&gt; weakActivity;</span><br><span class="line"></span><br><span class="line">        Token(ActivityRecord activity) &#123;</span><br><span class="line">            weakActivity = <span class="keyword">new</span> WeakReference&lt;ActivityRecord&gt;(activity);</span><br><span class="line">        &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Token继承自<code>IApplicationToken.Stub</code>，可以看出它其实也是Binder的一种。Token标识了一个ActivityRecord对象，即间接标识了一个Activity。</p>
<h2 id="3、token的传递"><a href="#3、token的传递" class="headerlink" title="3、token的传递"></a>3、token的传递</h2><h4 id="3-1-WindowManagerService-addAppToken"><a href="#3-1-WindowManagerService-addAppToken" class="headerlink" title="3.1 WindowManagerService addAppToken"></a>3.1 WindowManagerService addAppToken</h4><p>在启动Activity的过程中，会需要WMS去创建窗口（这里顺便提一句，WMS是在<code>SystemServer</code>启动时将WMS绑定在AMS上<code>mActivityManagerService.setWindowManager(wm)</code>），为了能让Activity与Window关联起来，token会传递给WMS：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * State and management of a single stack of activities.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityStack</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">startActivityLocked</span><span class="params">(ActivityRecord r, <span class="keyword">boolean</span> newTask,</span><br><span class="line">            <span class="keyword">boolean</span> doResume, <span class="keyword">boolean</span> keepCurTransition, Bundle options)</span> </span>&#123;</span><br><span class="line">	    ...</span><br><span class="line">	    mWindowManager.addAppToken(task.mActivities.indexOf(r),</span><br><span class="line">                    r.appToken, r.task.taskId, mStackId, r.info.screenOrientation, r.fullscreen,</span><br><span class="line">                    (r.info.flags &amp; ActivityInfo.FLAG_SHOW_ON_LOCK_SCREEN) != <span class="number">0</span>, r.userId,</span><br><span class="line">                    r.info.configChanges, task.voiceSession != <span class="keyword">null</span>, r.mLaunchTaskBehind);</span><br><span class="line">	    ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>WMS又会使用此token构造<code>AppWindowToken</code>，并保存起来：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WindowManagerService</span> <span class="keyword">extends</span> <span class="title">IWindowManager</span>.<span class="title">Stub</span></span><br><span class="line">        <span class="keyword">implements</span> <span class="title">Watchdog</span>.<span class="title">Monitor</span>, <span class="title">WindowManagerPolicy</span>.<span class="title">WindowManagerFuncs</span> </span>&#123;</span><br><span class="line">	...</span><br><span class="line">	<span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addAppToken</span><span class="params">(<span class="keyword">int</span> addPos, IApplicationToken token, <span class="keyword">int</span> taskId, <span class="keyword">int</span> stackId,</span><br><span class="line">            <span class="keyword">int</span> requestedOrientation, <span class="keyword">boolean</span> fullscreen, <span class="keyword">boolean</span> showWhenLocked, <span class="keyword">int</span> userId,</span><br><span class="line">            <span class="keyword">int</span> configChanges, <span class="keyword">boolean</span> voiceInteraction, <span class="keyword">boolean</span> launchTaskBehind)</span> </span>&#123;</span><br><span class="line">	    ...</span><br><span class="line">	    <span class="keyword">synchronized</span>(mWindowMap) &#123;</span><br><span class="line">            AppWindowToken atoken = findAppWindowToken(token.asBinder());</span><br><span class="line">            <span class="keyword">if</span> (atoken != <span class="keyword">null</span>) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Attempted to add existing app token: "</span> + token);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            atoken = <span class="keyword">new</span> AppWindowToken(<span class="keyword">this</span>, token, voiceInteraction);</span><br><span class="line">            ...</span><br><span class="line">            mTokenMap.put(token.asBinder(), atoken);</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">	    ...</span><br><span class="line">	&#125;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接着看ActivityStack::startActivityLocked这个函数，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">startActivityLocked</span><span class="params">(ActivityRecord r, <span class="keyword">boolean</span> newTask,</span><br><span class="line">            <span class="keyword">boolean</span> doResume, <span class="keyword">boolean</span> keepCurTransition, Bundle options)</span> </span>&#123;</span><br><span class="line">	...</span><br><span class="line">	<span class="keyword">boolean</span> doShow = <span class="keyword">true</span>;</span><br><span class="line">	<span class="keyword">if</span> (newTask) &#123;</span><br><span class="line">	    <span class="comment">// Even though this activity is starting fresh, we still need</span></span><br><span class="line">	    <span class="comment">// to reset it to make sure we apply affinities to move any</span></span><br><span class="line">	    <span class="comment">// existing activities from other tasks in to it.</span></span><br><span class="line">	    <span class="comment">// If the caller has requested that the target task be</span></span><br><span class="line">	    <span class="comment">// reset, then do so.</span></span><br><span class="line">	    <span class="keyword">if</span> ((r.intent.getFlags() &amp; Intent.FLAG_ACTIVITY_RESET_TASK_IF_NEEDED) != <span class="number">0</span>) &#123;</span><br><span class="line">	        resetTaskIfNeededLocked(r, r);</span><br><span class="line">	        doShow = topRunningNonDelayedActivityLocked(<span class="keyword">null</span>) == r;</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (options != <span class="keyword">null</span> &amp;&amp; <span class="keyword">new</span> ActivityOptions(options).getAnimationType()</span><br><span class="line">                    == ActivityOptions.ANIM_SCENE_TRANSITION) &#123;</span><br><span class="line">	    doShow = <span class="keyword">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (r.mLaunchTaskBehind) &#123;</span><br><span class="line">	    <span class="comment">// Don't do a starting window for mLaunchTaskBehind. More importantly make sure we</span></span><br><span class="line">	    <span class="comment">// tell WindowManager that r is visible even though it is at the back of the stack.</span></span><br><span class="line">	    mWindowManager.setAppVisibility(r.appToken, <span class="keyword">true</span>);</span><br><span class="line">	    ensureActivitiesVisibleLocked(<span class="keyword">null</span>, <span class="number">0</span>);</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (SHOW_APP_STARTING_PREVIEW &amp;&amp; doShow) &#123;</span><br><span class="line">	    <span class="comment">// Figure out if we are transitioning from another activity that is</span></span><br><span class="line">	    <span class="comment">// "has the same starting icon" as the next one.  This allows the</span></span><br><span class="line">	    <span class="comment">// window manager to keep the previous window it had previously</span></span><br><span class="line">	    <span class="comment">// created, if it still had one.</span></span><br><span class="line">	    ActivityRecord prev = mResumedActivity;</span><br><span class="line">	    <span class="keyword">if</span> (prev != <span class="keyword">null</span>) &#123;</span><br><span class="line">	        <span class="comment">// We don't want to reuse the previous starting preview if:</span></span><br><span class="line">	        <span class="comment">// (1) The current activity is in a different task.</span></span><br><span class="line">	        <span class="keyword">if</span> (prev.task != r.task) &#123;</span><br><span class="line">	            prev = <span class="keyword">null</span>;</span><br><span class="line">	        &#125;</span><br><span class="line">	        <span class="comment">// (2) The current activity is already displayed.</span></span><br><span class="line">	        <span class="keyword">else</span> <span class="keyword">if</span> (prev.nowVisible) &#123;</span><br><span class="line">	            prev = <span class="keyword">null</span>;</span><br><span class="line">	        &#125;</span><br><span class="line">	    &#125;</span><br><span class="line">	    mWindowManager.setAppStartingWindow(</span><br><span class="line">                        r.appToken, r.packageName, r.theme,</span><br><span class="line">                        mService.compatibilityInfoForPackageLocked(</span><br><span class="line">                                r.info.applicationInfo), r.nonLocalizedLabel,</span><br><span class="line">                        r.labelRes, r.icon, r.logo, r.windowFlags,</span><br><span class="line">                        prev != <span class="keyword">null</span> ? prev.appToken : <span class="keyword">null</span>, showStartingIcon);</span><br><span class="line">	    r.mStartingWindowShown = <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>正在启动的Activity组件的窗口接下来是要显示出来的情况下，即变量doShow的值等于true，AMS服务才会请求WMS服务为正在启动的Activity组件设置启动窗口。这部分的详细流程参见罗升阳老师的博客<a href="http://blog.csdn.net/luoshengyang/article/details/8577789" target="_blank" rel="external">Android窗口管理服务WindowManagerService显示Activity组件的启动窗口（Starting Window）的过程分析</a>。</p>
<h4 id="3-2-Activity-mToken"><a href="#3-2-Activity-mToken" class="headerlink" title="3.2 Activity mToken"></a>3.2 Activity mToken</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityStackSupervisor</span> <span class="keyword">implements</span> <span class="title">DisplayListener</span> </span>&#123;</span><br><span class="line">	...</span><br><span class="line">	<span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">realStartActivityLocked</span><span class="params">(ActivityRecord r,</span><br><span class="line">            ProcessRecord app, <span class="keyword">boolean</span> andResume, <span class="keyword">boolean</span> checkConfig)</span></span><br><span class="line">            <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">	    ...</span><br><span class="line">			app.thread.scheduleLaunchActivity(<span class="keyword">new</span> Intent(r.intent), r.appToken,</span><br><span class="line">                    System.identityHashCode(r), r.info, <span class="keyword">new</span> Configuration(mService.mConfiguration),</span><br><span class="line">                    r.compat, r.launchedFromPackage, r.task.voiceInteractor, app.repProcState,</span><br><span class="line">                    r.icicle, r.persistentState, results, newIntents, !andResume,</span><br><span class="line">                    mService.isNextTransitionForward(), profilerInfo);</span><br><span class="line">		...</span><br><span class="line">	&#125;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们来看，ApplicationThread中scheduleLaunchActivity函数做了什么？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityThread</span> </span>&#123;</span><br><span class="line">	...</span><br><span class="line">	<span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationThread</span> <span class="keyword">extends</span> <span class="title">ApplicationThreadNative</span> </span>&#123;</span><br><span class="line">	    ...</span><br><span class="line">	    <span class="comment">// we use token to identify this activity without having to send the</span></span><br><span class="line">        <span class="comment">// activity itself back to the activity manager. (matters more with ipc)</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">scheduleLaunchActivity</span><span class="params">(Intent intent, IBinder token, <span class="keyword">int</span> ident,</span><br><span class="line">                ActivityInfo info, Configuration curConfig, CompatibilityInfo compatInfo,</span><br><span class="line">                String referrer, IVoiceInteractor voiceInteractor, <span class="keyword">int</span> procState, Bundle state,</span><br><span class="line">                PersistableBundle persistentState, List&lt;ResultInfo&gt; pendingResults,</span><br><span class="line">                List&lt;ReferrerIntent&gt; pendingNewIntents, <span class="keyword">boolean</span> notResumed, <span class="keyword">boolean</span> isForward,</span><br><span class="line">                ProfilerInfo profilerInfo)</span> </span>&#123;</span><br><span class="line">	        ...</span><br><span class="line">	        ActivityClientRecord r = <span class="keyword">new</span> ActivityClientRecord();</span><br><span class="line"></span><br><span class="line">	        r.token = token;</span><br><span class="line">	        ...</span><br><span class="line">	        sendMessage(H.LAUNCH_ACTIVITY, r);</span><br><span class="line">	    &#125;</span><br><span class="line">	    ...</span><br><span class="line">	&#125;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里是生成了一个ActivityClientRecord对象，顾名思义，就是客户端（相对于AMS来说）的Activity记录，之后发送一条LAUNCH_ACTIVITY消息。</p>
<p>我们再来看handleLaunchAcitivity后续的流程，在ActivityThread::performLaunchActivity中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityThread</span> </span>&#123;</span><br><span class="line">	...</span><br><span class="line">	<span class="function"><span class="keyword">private</span> Activity <span class="title">performLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> </span>&#123;</span><br><span class="line">	    ...</span><br><span class="line">	    Activity activity = <span class="keyword">null</span>;</span><br><span class="line">	    <span class="keyword">try</span> &#123;</span><br><span class="line">            java.lang.ClassLoader cl = r.packageInfo.getClassLoader();</span><br><span class="line">            activity = mInstrumentation.newActivity(</span><br><span class="line">                    cl, component.getClassName(), r.intent);</span><br><span class="line">            StrictMode.incrementExpectedActivityCount(activity.getClass());</span><br><span class="line">            r.intent.setExtrasClassLoader(cl);</span><br><span class="line">            r.intent.prepareToEnterProcess();</span><br><span class="line">            <span class="keyword">if</span> (r.state != <span class="keyword">null</span>) &#123;</span><br><span class="line">                r.state.setClassLoader(cl);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">	        ...</span><br><span class="line">        &#125;</span><br><span class="line">      	</span><br><span class="line">	    ...</span><br><span class="line">	    activity.attach(appContext, <span class="keyword">this</span>, getInstrumentation(), r.token,</span><br><span class="line">                        r.ident, app, r.intent, r.activityInfo, title, r.parent,</span><br><span class="line">                        r.embeddedID, r.lastNonConfigurationInstances, config,</span><br><span class="line">                        r.referrer, r.voiceInteractor);</span><br><span class="line">	    ...</span><br><span class="line">	&#125;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段代码，用反射机制，把我们配置好的activity对象实例化出来，如果成功实例化，就调用Activity::attch函数，当然也会把我们从ams传入过来的token对象一起带过去。</p>
<p>接着看Activity的attach函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Activity</span> <span class="keyword">extends</span> <span class="title">ContextThemeWrapper</span></span><br><span class="line">        <span class="keyword">implements</span> <span class="title">LayoutInflater</span>.<span class="title">Factory2</span>,</span><br><span class="line">        <span class="title">Window</span>.<span class="title">Callback</span>, <span class="title">KeyEvent</span>.<span class="title">Callback</span>,</span><br><span class="line">        <span class="title">OnCreateContextMenuListener</span>, <span class="title">ComponentCallbacks2</span>,</span><br><span class="line">        <span class="title">Window</span>.<span class="title">OnWindowDismissedCallback</span> </span>&#123;</span><br><span class="line">	...</span><br><span class="line">	<span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(Context context, ActivityThread aThread,</span><br><span class="line">            Instrumentation instr, IBinder token, <span class="keyword">int</span> ident,</span><br><span class="line">            Application application, Intent intent, ActivityInfo info,</span><br><span class="line">            CharSequence title, Activity parent, String id,</span><br><span class="line">            NonConfigurationInstances lastNonConfigurationInstances,</span><br><span class="line">            Configuration config, String referrer, IVoiceInteractor voiceInteractor)</span> </span>&#123;</span><br><span class="line">      </span><br><span class="line">	    attachBaseContext(context);</span><br><span class="line">	    mFragments.attachActivity(<span class="keyword">this</span>, mContainer, <span class="keyword">null</span>);</span><br><span class="line">	    mWindow = PolicyManager.makeNewWindow(<span class="keyword">this</span>);</span><br><span class="line">	    mWindow.setCallback(<span class="keyword">this</span>);</span><br><span class="line">	    mToken = token;</span><br><span class="line">	    ...</span><br><span class="line">	    mWindow.setWindowManager(</span><br><span class="line">                (WindowManager)context.getSystemService(Context.WINDOW_SERVICE),</span><br><span class="line">                mToken, mComponent.flattenToString(),</span><br><span class="line">                (info.flags &amp; ActivityInfo.FLAG_HARDWARE_ACCELERATED) != <span class="number">0</span>);</span><br><span class="line">	    ...</span><br><span class="line">	&#125;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段代码中创建了Window实例，即是当前Activity对应的Window对象，而且Activity的mToken值就是AMS里面ActivityRecord的appToken值。</p>
<p>写的好累！ &gt;_&lt;</p>
</div></article></div></section><footer><div class="paginator"><a href="/2016/10/30/install_apk/" class="prev">上一篇</a><a href="/2016/08/20/launch_app/" class="next">下一篇</a></div><div style="padding:0; margin: 30px auto; width: 100%; text-align: center;"><div style="font-size: 1em; margin: 10px auto;color:#f44336;font-weight: bold"> 如果觉得本文对你有帮助，不妨请作者喝瓶养乐多<div style="padding: 0; margin: 10px auto; width: 100%; text-align: center; color:#f44336;"></div></div><button style="cursor: pointer; border: 0; outline: 0; padding: 0; margin: 0; letter-spacing: normal; text-transform: none; text-indent: 0; text-shadow: none; background-color: transparent; text-align: center; cursor: pointer;" id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}"><span style="display: inline-block; width: 70px; height: 70px; color: #fff; font-weight: bold; font-style: normal; font-variant: normal; font-stretch: normal; font-size: 2.5em; text-align: center; line-height: 70px; background: #f44336; -moz-border-radius: 50%; -webkit-border-radius: 50%; border-radius: 50%;">赏</span></button><div id="QR" style="display: none;"><div id="wechat" style="width: auto; max-width: 50%; float: left; margin: 20px; display: inline-block;"><img id="wechat_qr" src="/images/wechat.png" alt="WechatPay"></div><div id="alipay" style="width: auto; max-width: 50%; float: right; margin: 20px; display: inline-block;"><img id="alipay_qr" src="/images/alipay.png" alt="Alipay"></div></div></div><div data-thread-key="2016/09/15/framework_token/" data-title="理解token在Framework中的产生及作用" data-url="http://solart.cc/2016/09/15/framework_token/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"solart"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>© 2015 - 2017 <a href="http://solart.cc">imilk</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-51018462-1",'auto');ga('send','pageview');</script></body></html>