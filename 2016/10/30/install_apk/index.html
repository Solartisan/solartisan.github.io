<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Android应用安装流程分析 · Solartisan</title><meta name="description" content="Android应用安装流程分析 - imilk"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://solart.cc/atom.xml" title="Solartisan"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/logo.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">HOME</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/solartisan" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">Android应用安装流程分析</h1><div class="post-info">Oct 30, 2016</div><div class="post-content"><p>作者：<a href="mailto://imilko7@gmail.com" target="_blank" rel="external">imilk</a></p>
<blockquote>
<p>版权声明：本文图文为博主原创，转载请注明出处。</p>
</blockquote>
<p>这段时间在研究插件化相关的技术，追根溯源，所以干脆把Apk的安装流程梳理了一遍，与大家共享，望指正！</p>
<p>本文基于Android 5.1的源码，分析Apk安装流程。</p>
<p>Apk是Android Pakage的缩写，即Android安装包，Apk文件其实是zip格式，一般包含一个或多个dex文件、resources.arsc、AndroidManifest.xml、res目录、META-INF目录及包含so库的lib目录，这里就不在啰嗦。</p>
<a id="more"></a>
<p> <img src="/images/apk_content.png" alt="apk_content"></p>
<h2 id="1、安装流程图"><a href="#1、安装流程图" class="headerlink" title="1、安装流程图"></a>1、安装流程图</h2><p>先来看一张整体的流程图：</p>
<p><img src="/images/Install_apk.png" alt="install_apk"></p>
<p>安装过程：复制apk安装包到/data/app目录下，解压并扫描安装包，向资源管理器注入apk资源，解析AndroidManifest文件，并在/data/data目录下创建对应的应用数据目录，然后针对dalvik/art环境优化dex文件，保存到dalvik-cache目录，将AndroidManifest文件解析出的组件、权限注册到PackageManagerService，完成后发送广播。</p>
<h2 id="2、安装时序图"><a href="#2、安装时序图" class="headerlink" title="2、安装时序图"></a>2、安装时序图</h2><p>上图太过笼统，不利于了解细节，这里整理出一张时序图，以便于分析。</p>
<p><img src="/images/install_apk_seq.png" alt="install_apk_seq"></p>
<p><a href="/images/install_apk_seq.png">点击放大查看高清无码大图</a></p>
<blockquote>
<p>说明：时序图中划分为三个部分：PackageInstaller进程、System进程、DefaultContainerService进程，重点关注System进程中的PackageManagerService。</p>
<p><strong>PackageManagerService</strong>：PMS是Android中最核心的服务之一，主要负责对系统的apk进行管理，以及对四大组件的管理。</p>
</blockquote>
<h2 id="3、流程分析"><a href="#3、流程分析" class="headerlink" title="3、流程分析"></a>3、流程分析</h2><p>用户安装Apk时，如从厂商官方应用市场下载，一般无安装页面，这里以用户安装第三方安装包为例进行分析，PackageInstaller应用负责安装及卸载过程与用户交互（见时序图PackageInstaller进程）。这里着重介绍System进程PMS安装流程。</p>
<h4 id="3-1-将apk文件复制至-data-app目录"><a href="#3-1-将apk文件复制至-data-app目录" class="headerlink" title="3.1 将apk文件复制至/data/app目录"></a>3.1 将apk文件复制至/data/app目录</h4><p>此流程在时序图中过程还是挺繁复的，中间涉及到比较多的跳转，我们挑重点看：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PackageManagerService</span> <span class="keyword">extends</span> <span class="title">IPackageManager</span>.<span class="title">Stub</span> </span>&#123;</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">installPackageAsUser</span><span class="params">(String originPath, IPackageInstallObserver2 observer,</span><br><span class="line">            <span class="keyword">int</span> installFlags, String installerPackageName, VerificationParams verificationParams,</span><br><span class="line">            String packageAbiOverride, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">final</span> Message msg = mHandler.obtainMessage(INIT_COPY);</span><br><span class="line">        msg.obj = <span class="keyword">new</span> InstallParams(origin, observer, installFlags,</span><br><span class="line">                installerPackageName, verificationParams, user, packageAbiOverride);</span><br><span class="line">        mHandler.sendMessage(msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此处，通过PackageHandler发送INIT_COPY消息准备复制apk，我们再来接着看，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PackageHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">doHandleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">             <span class="keyword">case</span> INIT_COPY: &#123;</span><br><span class="line">                    HandlerParams params = (HandlerParams) msg.obj;</span><br><span class="line">                    <span class="keyword">int</span> idx = mPendingInstalls.size();</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG_INSTALL) Slog.i(TAG, <span class="string">"init_copy idx="</span> + idx + <span class="string">": "</span> + params);</span><br><span class="line">                    <span class="comment">// If a bind was already initiated we dont really</span></span><br><span class="line">                    <span class="comment">// need to do anything. The pending install</span></span><br><span class="line">                    <span class="comment">// will be processed later on.</span></span><br><span class="line">                    <span class="keyword">if</span> (!mBound) &#123;</span><br><span class="line">                        <span class="comment">// If this is the only one pending we might</span></span><br><span class="line">                        <span class="comment">// have to bind to the service again.</span></span><br><span class="line">                        <span class="keyword">if</span> (!connectToService()) &#123;</span><br><span class="line">                            Slog.e(TAG, <span class="string">"Failed to bind to media container service"</span>);</span><br><span class="line">                            params.serviceError();</span><br><span class="line">                            <span class="keyword">return</span>;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="comment">// Once we bind to the service, the first</span></span><br><span class="line">                            <span class="comment">// pending request will be processed.</span></span><br><span class="line">                            mPendingInstalls.add(idx, params);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        mPendingInstalls.add(idx, params);</span><br><span class="line">                        <span class="comment">// Already bound to the service. Just make</span></span><br><span class="line">                        <span class="comment">// sure we trigger off processing the first request.</span></span><br><span class="line">                        <span class="keyword">if</span> (idx == <span class="number">0</span>) &#123;</span><br><span class="line">                            mHandler.sendEmptyMessage(MCS_BOUND);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="keyword">case</span> MCS_BOUND: &#123;</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG_INSTALL) Slog.i(TAG, <span class="string">"mcs_bound"</span>);</span><br><span class="line">                    <span class="keyword">if</span> (msg.obj != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        mContainerService = (IMediaContainerService) msg.obj;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (mContainerService == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        ...</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mPendingInstalls.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        HandlerParams params = mPendingInstalls.get(<span class="number">0</span>);</span><br><span class="line">                        <span class="keyword">if</span> (params != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (params.startCopy()) &#123;</span><br><span class="line">                                <span class="comment">// We are done...  look for more work or to</span></span><br><span class="line">                                <span class="comment">// go idle.</span></span><br><span class="line">                                </span><br><span class="line">                                <span class="comment">// Delete pending install</span></span><br><span class="line">                                <span class="keyword">if</span> (mPendingInstalls.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                    mPendingInstalls.remove(<span class="number">0</span>);</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="keyword">if</span> (mPendingInstalls.size() == <span class="number">0</span>) &#123;</span><br><span class="line">                                    <span class="keyword">if</span> (mBound) &#123;</span><br><span class="line">                                        <span class="keyword">if</span> (DEBUG_SD_INSTALL) Log.i(TAG,</span><br><span class="line">                                                <span class="string">"Posting delayed MCS_UNBIND"</span>);</span><br><span class="line">                                        removeMessages(MCS_UNBIND);</span><br><span class="line">                                        Message ubmsg = obtainMessage(MCS_UNBIND);</span><br><span class="line">                                        <span class="comment">// Unbind after a little delay, to avoid</span></span><br><span class="line">                                        <span class="comment">// continual thrashing.</span></span><br><span class="line">                                        sendMessageDelayed(ubmsg, <span class="number">10000</span>);</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                    <span class="comment">// There are more pending requests in queue.</span></span><br><span class="line">                                    <span class="comment">// Just post MCS_BOUND message to trigger processing</span></span><br><span class="line">                                    <span class="comment">// of next pending install.</span></span><br><span class="line">                                    <span class="keyword">if</span> (DEBUG_SD_INSTALL) Log.i(TAG,</span><br><span class="line">                                            <span class="string">"Posting MCS_BOUND for next work"</span>);</span><br><span class="line">                                    mHandler.sendEmptyMessage(MCS_BOUND);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">// Should never happen ideally.</span></span><br><span class="line">                        Slog.w(TAG, <span class="string">"Empty queue"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">             &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>INIT_COPY这条case主要是确保<code>DefaultContainerService</code>已经绑定，DefaultContainerService是一个单独的apk进程，主要提供检查和复制设备上的文件的服务。MCS_BOUND这条case中最关键的是执行<code>params.startCopy()</code>开始拷贝工作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InstallParams</span> <span class="keyword">extends</span> <span class="title">HandlerParams</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleStartCopy</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (onInt &amp;&amp; onSd) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            pkgLite = mContainerService.getMinimalPackageInfo(origin.resolvedPath, installFlags, packageAbiOverride);</span><br><span class="line">        ...</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">final</span> InstallArgs args = createInstallArgs(<span class="keyword">this</span>);</span><br><span class="line">        mArgs = args;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ret == PackageManager.INSTALL_SUCCEEDED) &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">if</span> (!origin.existing &amp;&amp; requiredUid != -<span class="number">1</span></span><br><span class="line">                        &amp;&amp; isVerificationEnabled(userIdentifier, installFlags)) &#123;</span><br><span class="line">                ...</span><br><span class="line">                <span class="keyword">if</span> (ret == PackageManager.INSTALL_SUCCEEDED</span><br><span class="line">                            &amp;&amp; mRequiredVerifierPackage != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="comment">/*</span><br><span class="line">                         * Send the intent to the required verification agent,</span><br><span class="line">                         * but only start the verification timeout after the</span><br><span class="line">                         * target BroadcastReceivers have run.</span><br><span class="line">                         */</span></span><br><span class="line">                        verification.setComponent(requiredVerifierComponent);</span><br><span class="line">                        mContext.sendOrderedBroadcastAsUser(verification, getUser(),</span><br><span class="line">                                android.Manifest.permission.PACKAGE_VERIFICATION_AGENT,</span><br><span class="line">                                <span class="keyword">new</span> BroadcastReceiver() &#123;</span><br><span class="line">                                    <span class="annotation">@Override</span></span><br><span class="line">                                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</span><br><span class="line">                                        <span class="keyword">final</span> Message msg = mHandler</span><br><span class="line">                                                .obtainMessage(CHECK_PENDING_VERIFICATION);</span><br><span class="line">                                        msg.arg1 = verificationId;</span><br><span class="line">                                        mHandler.sendMessageDelayed(msg, getVerificationTimeout());</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;, <span class="keyword">null</span>, <span class="number">0</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">                        <span class="comment">/*</span><br><span class="line">                         * We don't want the copy to proceed until verification</span><br><span class="line">                         * succeeds, so null out this field.</span><br><span class="line">                         */</span></span><br><span class="line">                        mArgs = <span class="keyword">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">/*</span><br><span class="line">                 * No package verification is enabled, so immediately start</span><br><span class="line">                 * the remote call to initiate copy using temporary file.</span><br><span class="line">                 */</span></span><br><span class="line">                ret = args.copyApk(mContainerService, <span class="keyword">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这部分主要是检查存储空间，权限等，若已有软件包验证程序，则需要等待验证程序检验安装包，否则可直接安装。这里我们直接来看<code>args.copyApk</code>。这里需要提到的是<code>createInstallArgs(this)</code>会根据InstallParams来判断安装位置，这里以内部存储安装为例。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileInstallArgs</span> <span class="keyword">extends</span> <span class="title">InstallArgs</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">copyApk</span><span class="params">(IMediaContainerService imcs, <span class="keyword">boolean</span> temp)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">final</span> File tempDir = mInstallerService.allocateInternalStageDirLegacy();</span><br><span class="line">                codeFile = tempDir;</span><br><span class="line">                resourceFile = tempDir;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Failed to create copy file: "</span> + e);</span><br><span class="line">                <span class="keyword">return</span> PackageManager.INSTALL_FAILED_INSUFFICIENT_STORAGE;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> IParcelFileDescriptorFactory target = <span class="keyword">new</span> IParcelFileDescriptorFactory.Stub() &#123;</span><br><span class="line">                <span class="annotation">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> ParcelFileDescriptor <span class="title">open</span><span class="params">(String name, <span class="keyword">int</span> mode)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">                    ...</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> ret = PackageManager.INSTALL_SUCCEEDED;</span><br><span class="line">            ret = imcs.copyPackage(origin.file.getAbsolutePath(), target);</span><br><span class="line">            <span class="keyword">if</span> (ret != PackageManager.INSTALL_SUCCEEDED) &#123;</span><br><span class="line">                Slog.e(TAG, <span class="string">"Failed to copy package"</span>);</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> File libraryRoot = <span class="keyword">new</span> File(codeFile, LIB_DIR_NAME);</span><br><span class="line">            NativeLibraryHelper.Handle handle = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                handle = NativeLibraryHelper.Handle.create(codeFile);</span><br><span class="line">                ret = NativeLibraryHelper.copyNativeBinariesWithOverride(handle, libraryRoot,</span><br><span class="line">                        abiOverride);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                Slog.e(TAG, <span class="string">"Copying native libraries failed"</span>, e);</span><br><span class="line">                ret = PackageManager.INSTALL_FAILED_INTERNAL_ERROR;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                IoUtils.closeQuietly(handle);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里完成了apk拷贝及so库的拷贝。</p>
<h4 id="3-2-解析安装包"><a href="#3-2-解析安装包" class="headerlink" title="3.2 解析安装包"></a>3.2 解析安装包</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PackageManagerService</span> <span class="keyword">extends</span> <span class="title">IPackageManager</span>.<span class="title">Stub</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processPendingInstall</span><span class="params">(<span class="keyword">final</span> InstallArgs args, <span class="keyword">final</span> <span class="keyword">int</span> currentStatus)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Queue up an async operation since the package installation may take a little while.</span></span><br><span class="line">        mHandler.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                ...</span><br><span class="line">                <span class="keyword">if</span> (res.returnCode == PackageManager.INSTALL_SUCCEEDED) &#123;</span><br><span class="line">                    args.doPreInstall(res.returnCode);</span><br><span class="line">                    <span class="keyword">synchronized</span> (mInstallLock) &#123;</span><br><span class="line">                        installPackageLI(args, res);</span><br><span class="line">                    &#125;</span><br><span class="line">                    args.doPostInstall(res.returnCode, res.uid);</span><br><span class="line">                &#125;</span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">installPackageLI</span><span class="params">(InstallArgs args, PackageInstalledInfo res)</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        PackageParser pp = <span class="keyword">new</span> PackageParser();</span><br><span class="line">        ...</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">final</span> PackageParser.Package pkg;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            pkg = pp.parsePackage(tmpPackageFile, parseFlags);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (PackageParserException e) &#123;</span><br><span class="line">            res.setError(<span class="string">"Failed parse during installPackageLI"</span>, e);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (replace) &#123;</span><br><span class="line">            replacePackageLI(pkg, parseFlags, scanFlags | SCAN_REPLACING, args.user,</span><br><span class="line">                    installerPackageName, res);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            installNewPackageLI(pkg, parseFlags, scanFlags | SCAN_DELETE_DATA_ON_FAILURES,</span><br><span class="line">                    args.user, installerPackageName, res);</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此处对于安装包进行解析，包括解析<code>AndroidManifest</code>版本、权限、组件等，详见<code>PackageParser::parsePackage(tmpPackageFile, parseFlags)</code>，这部分代码量较大但流程清晰，这里简单看一下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PackageParser</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Package <span class="title">parsePackage</span><span class="params">(File packageFile, <span class="keyword">int</span> flags)</span> <span class="keyword">throws</span> PackageParserException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (packageFile.isDirectory()) &#123;</span><br><span class="line">            <span class="keyword">return</span> parseClusterPackage(packageFile, flags);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> parseMonolithicPackage(packageFile, flags);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Package <span class="title">parseMonolithicPackage</span><span class="params">(File apkFile, <span class="keyword">int</span> flags)</span> <span class="keyword">throws</span> PackageParserException </span>&#123;</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> AssetManager assets = <span class="keyword">new</span> AssetManager();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> Package pkg = parseBaseApk(apkFile, assets, flags);</span><br><span class="line">            pkg.codePath = apkFile.getAbsolutePath();</span><br><span class="line">            <span class="keyword">return</span> pkg;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            IoUtils.closeQuietly(assets);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">private</span> Package <span class="title">parseBaseApk</span><span class="params">(File apkFile, AssetManager assets, <span class="keyword">int</span> flags)</span></span><br><span class="line">            <span class="keyword">throws</span> PackageParserException </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">//将资源添加进资源管理</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> cookie = loadApkIntoAssetManager(assets, apkPath, flags);</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            res = <span class="keyword">new</span> Resources(assets, mMetrics, <span class="keyword">null</span>);</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">final</span> String[] outError = <span class="keyword">new</span> String[<span class="number">1</span>];</span><br><span class="line">            <span class="comment">//这里解析manifest文件，具体就不在展开，详看请移步源码</span></span><br><span class="line">            <span class="keyword">final</span> Package pkg = parseBaseApk(res, parser, flags, outError);</span><br><span class="line">            ...</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> pkg;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (PackageParserException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> PackageParserException(INSTALL_PARSE_FAILED_UNEXPECTED_EXCEPTION,</span><br><span class="line">                    <span class="string">"Failed to read manifest from "</span> + apkPath, e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            IoUtils.closeQuietly(parser);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-3-检测权限、注册组件"><a href="#3-3-检测权限、注册组件" class="headerlink" title="3.3 检测权限、注册组件"></a>3.3 检测权限、注册组件</h4><p>接下来看执行<code>installNewPackageLI</code>函数，这部分代码核心为<code>scanPackageLI</code>、<code>updateSettingsLI</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PackageManagerService</span> <span class="keyword">extends</span> <span class="title">IPackageManager</span>.<span class="title">Stub</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">installNewPackageLI</span><span class="params">(PackageParser.Package pkg,</span><br><span class="line">            <span class="keyword">int</span> parseFlags, <span class="keyword">int</span> scanFlags, UserHandle user,</span><br><span class="line">            String installerPackageName, PackageInstalledInfo res)</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            PackageParser.Package newPackage = scanPackageLI(pkg, parseFlags, scanFlags,</span><br><span class="line">                    System.currentTimeMillis(), user);</span><br><span class="line"></span><br><span class="line">            updateSettingsLI(newPackage, installerPackageName, <span class="keyword">null</span>, <span class="keyword">null</span>, res);</span><br><span class="line">            <span class="comment">// delete the partially installed application. the data directory will have to be</span></span><br><span class="line">            <span class="comment">// restored if it was already existing</span></span><br><span class="line">            <span class="keyword">if</span> (res.returnCode != PackageManager.INSTALL_SUCCEEDED) &#123;</span><br><span class="line">                <span class="comment">// remove package from internal structures.  Note that we want deletePackageX to</span></span><br><span class="line">                <span class="comment">// delete the package data and cache directories that it created in</span></span><br><span class="line">                <span class="comment">// scanPackageLocked, unless those directories existed before we even tried to</span></span><br><span class="line">                <span class="comment">// install.</span></span><br><span class="line">                deletePackageLI(pkgName, UserHandle.ALL, <span class="keyword">false</span>, <span class="keyword">null</span>, <span class="keyword">null</span>,</span><br><span class="line">                        dataDirExists ? PackageManager.DELETE_KEEP_DATA : <span class="number">0</span>,</span><br><span class="line">                                res.removedInfo, <span class="keyword">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (PackageManagerException e) &#123;</span><br><span class="line">            res.setError(<span class="string">"Package couldn't be installed in "</span> + pkg.codePath, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>scanPackageLI负责安装，而updateSettingLI则是完成安装后的设置信息更新。如果安装失败则会删除安装包。</p>
<p>我们来看<code>scanPackageLI</code>这部分代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PackageManagerService</span> <span class="keyword">extends</span> <span class="title">IPackageManager</span>.<span class="title">Stub</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">private</span> PackageParser.<span class="function">Package <span class="title">scanPackageLI</span><span class="params">(PackageParser.Package pkg, <span class="keyword">int</span> parseFlags,</span><br><span class="line">            <span class="keyword">int</span> scanFlags, <span class="keyword">long</span> currentTime, UserHandle user)</span> <span class="keyword">throws</span> PackageManagerException </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> success = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> PackageParser.Package res = scanPackageDirtyLI(pkg, parseFlags, scanFlags,</span><br><span class="line">                    currentTime, user);</span><br><span class="line">            success = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">return</span> res;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!success &amp;&amp; (scanFlags &amp; SCAN_DELETE_DATA_ON_FAILURES) != <span class="number">0</span>) &#123;</span><br><span class="line">                removeDataDirsLI(pkg.packageName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">private</span> PackageParser.<span class="function">Package <span class="title">scanPackageDirtyLI</span><span class="params">(PackageParser.Package pkg, <span class="keyword">int</span> parseFlags,</span><br><span class="line">            <span class="keyword">int</span> scanFlags, <span class="keyword">long</span> currentTime, UserHandle user)</span> <span class="keyword">throws</span> PackageManagerException </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// writer</span></span><br><span class="line">        <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">            <span class="comment">// 验证已注册的ContentProvider是否有其他同名</span></span><br><span class="line">            <span class="keyword">if</span> ((scanFlags &amp; SCAN_NEW_INSTALL) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> N = pkg.providers.size();</span><br><span class="line">                <span class="keyword">int</span> i;</span><br><span class="line">                <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">                    PackageParser.Provider p = pkg.providers.get(i);</span><br><span class="line">                    <span class="keyword">if</span> (p.info.authority != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        String names[] = p.info.authority.split(<span class="string">";"</span>);</span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; names.length; j++) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (mProvidersByAuthority.containsKey(names[j])) &#123;</span><br><span class="line">                                PackageParser.Provider other = mProvidersByAuthority.get(names[j]);</span><br><span class="line">                                <span class="keyword">final</span> String otherPackageName =</span><br><span class="line">                                        ((other != <span class="keyword">null</span> &amp;&amp; other.getComponentName() != <span class="keyword">null</span>) ?</span><br><span class="line">                                                other.getComponentName().getPackageName() : <span class="string">"?"</span>);</span><br><span class="line">                                <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(</span><br><span class="line">                                        INSTALL_FAILED_CONFLICTING_PROVIDER,</span><br><span class="line">                                                <span class="string">"Can't install because provider name "</span> + names[j]</span><br><span class="line">                                                + <span class="string">" (in package "</span> + pkg.applicationInfo.packageName</span><br><span class="line">                                                + <span class="string">") is already used by "</span> + otherPackageName);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">if</span> (mPlatformPackage == pkg) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// This is a normal package, need to make its data directory.</span></span><br><span class="line">            dataPath = getDataPathForPackage(pkg.packageName, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (dataPath.exists()) &#123;</span><br><span class="line">                ...</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//invoke installer to do the actual installation</span></span><br><span class="line">                <span class="comment">//这里创建了应用数据目录，用于存放用户数据</span></span><br><span class="line">                <span class="keyword">int</span> ret = createDataDirsLI(pkgName, pkg.applicationInfo.uid,</span><br><span class="line">                                           pkg.applicationInfo.seinfo);</span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">          </span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// We also need to dexopt any apps that are dependent on this library.  Note that</span></span><br><span class="line">        <span class="comment">// if these fail, we should abort the install since installing the library will</span></span><br><span class="line">        <span class="comment">// result in some apps being broken.</span></span><br><span class="line">        <span class="keyword">if</span> (clientLibPkgs != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((scanFlags &amp; SCAN_NO_DEX) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; clientLibPkgs.size(); i++) &#123;</span><br><span class="line">                    PackageParser.Package clientPkg = clientLibPkgs.get(i);</span><br><span class="line">                    <span class="keyword">if</span> (performDexOptLI(clientPkg, <span class="keyword">null</span> <span class="comment">/* instruction sets */</span>, forceDex,</span><br><span class="line">                            (scanFlags &amp; SCAN_DEFER_DEX) != <span class="number">0</span>, <span class="keyword">false</span>) == DEX_OPT_FAILED) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_DEXOPT,</span><br><span class="line">                                <span class="string">"scanPackageLI failed to dexopt clientLibPkgs"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// writer</span></span><br><span class="line">        <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="comment">// 以下对四大组件进行注册</span></span><br><span class="line">            <span class="keyword">int</span> N = pkg.providers.size();</span><br><span class="line">            StringBuilder r = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">int</span> i;</span><br><span class="line">            <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">                PackageParser.Provider p = pkg.providers.get(i);</span><br><span class="line">                p.info.processName = fixProcessName(pkg.applicationInfo.processName,</span><br><span class="line">                        p.info.processName, pkg.applicationInfo.uid);</span><br><span class="line">                mProviders.addProvider(p);</span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>scanPackageLI()方法主要逻辑是由<code>scanPackageDirtyLI()</code>实现。这里主要对provider冲突检测，创建应用数据目录，dexopt操作，四大组件注册，权限注册等。</p>
<h4 id="3-4-安装完成"><a href="#3-4-安装完成" class="headerlink" title="3.4 安装完成"></a>3.4 安装完成</h4><p>继续看<code>processPendingInstall</code>，安装成功后如需要备份则会通过<code>BackupManagerService</code>进行备份：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PackageManagerService</span> <span class="keyword">extends</span> <span class="title">IPackageManager</span>.<span class="title">Stub</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processPendingInstall</span><span class="params">(<span class="keyword">final</span> InstallArgs args, <span class="keyword">final</span> <span class="keyword">int</span> currentStatus)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Queue up an async operation since the package installation may take a little while.</span></span><br><span class="line">        mHandler.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                ...</span><br><span class="line">                <span class="keyword">if</span> (res.returnCode == PackageManager.INSTALL_SUCCEEDED &amp;&amp; doRestore) &#123;</span><br><span class="line">                    IBackupManager bm = IBackupManager.Stub.asInterface(</span><br><span class="line">                            ServiceManager.getService(Context.BACKUP_SERVICE));</span><br><span class="line">                    <span class="keyword">if</span> (bm != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (DEBUG_INSTALL) Log.v(TAG, <span class="string">"token "</span> + token</span><br><span class="line">                                + <span class="string">" to BM for possible restore"</span>);</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="keyword">if</span> (bm.isBackupServiceActive(UserHandle.USER_OWNER)) &#123;</span><br><span class="line">                                bm.restoreAtInstall(res.pkg.applicationInfo.packageName, token);</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                doRestore = <span class="keyword">false</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                            <span class="comment">// can't happen; the backup manager is local</span></span><br><span class="line">                        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                            Slog.e(TAG, <span class="string">"Exception trying to enqueue restore"</span>, e);</span><br><span class="line">                            doRestore = <span class="keyword">false</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        Slog.e(TAG, <span class="string">"Backup Manager not found!"</span>);</span><br><span class="line">                        doRestore = <span class="keyword">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!doRestore) &#123;</span><br><span class="line">                    <span class="comment">// No restore possible, or the Backup Manager was mysteriously not</span></span><br><span class="line">                    <span class="comment">// available -- just fire the post-install work request directly.</span></span><br><span class="line">                    <span class="keyword">if</span> (DEBUG_INSTALL) Log.v(TAG, <span class="string">"No restore - queue post-install for "</span> + token);</span><br><span class="line">                    Message msg = mHandler.obtainMessage(POST_INSTALL, token, <span class="number">0</span>);</span><br><span class="line">                    mHandler.sendMessage(msg);</span><br><span class="line">                &#125;</span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>无论备份与否，最终则会通过<code>PackageHandler</code>发送POST_INSTALL消息，最终通过发送<code>Intent.ACTION_PACKAGE_ADDED</code>广播，apk的安装流程就到此结束了。</p>
</div></article></div></section><footer><div class="paginator"><a href="/2016/11/16/plugin_classloader/" class="prev">上一篇</a><a href="/2016/09/15/framework_token/" class="next">下一篇</a></div><div style="padding:0; margin: 30px auto; width: 100%; text-align: center;"><div style="font-size: 1em; margin: 10px auto;color:#f44336;font-weight: bold"> 如果觉得本文对你有帮助，不妨请作者喝瓶养乐多<div style="padding: 0; margin: 10px auto; width: 100%; text-align: center; color:#f44336;"></div></div><button style="cursor: pointer; border: 0; outline: 0; padding: 0; margin: 0; letter-spacing: normal; text-transform: none; text-indent: 0; text-shadow: none; background-color: transparent; text-align: center; cursor: pointer;" id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}"><span style="display: inline-block; width: 70px; height: 70px; color: #fff; font-weight: bold; font-style: normal; font-variant: normal; font-stretch: normal; font-size: 2.5em; text-align: center; line-height: 70px; background: #f44336; -moz-border-radius: 50%; -webkit-border-radius: 50%; border-radius: 50%;">赏</span></button><div id="QR" style="display: none;"><div id="wechat" style="width: auto; max-width: 50%; float: left; margin: 20px; display: inline-block;"><img id="wechat_qr" src="/images/wechat.png" alt="WechatPay"></div><div id="alipay" style="width: auto; max-width: 50%; float: right; margin: 20px; display: inline-block;"><img id="alipay_qr" src="/images/alipay.png" alt="Alipay"></div></div></div><div data-thread-key="2016/10/30/install_apk/" data-title="Android应用安装流程分析" data-url="http://solart.cc/2016/10/30/install_apk/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"solart"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>© 2015 - 2016 <a href="http://solart.cc">imilk</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-51018462-1",'auto');ga('send','pageview');</script></body></html>